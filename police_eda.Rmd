---
title: "Police EDA"
author: Connie Wu
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(ggplot2)
library(dplyr)
library(tidyr)
library(tidyverse)
```


## Load Data

```{r}
library(ggplot2)
library(dplyr)
library(tidyr)
library(tidyverse)
```

```{r load-data}
# Census Predictors
census <- read.csv("data/2013census.csv")[,-c(8,9)]
states <- lapply(census$department, function(x) str_extract_all(x,"\\([^()]+\\)")[[1]])
states <- substring(states, 2, nchar(states)-1)
census$state <- states

# Gun Law Predictors
gun_provisions <- read.csv("data/gun_provisions.csv") %>% 
  filter(year == 2013)
gun_provisions <- gun_provisions %>% 
  mutate(total_pr = rowSums(gun_provisions[,3:136]),
         deesc_train = ifelse(state %in% c("California", "New Mexico", "Texas", "Oklahoma", "South Dakota", "Illinois", "Indiana", "Tennessee", "Washington", "Missouri", "Georgia", "Ohio", "Maryland", "Massachusetts", "Connecticut", "Maine"), 1, 0)) %>% 
  select(state, total_pr, deesc_train)
gun_provisions$state <- state.abb[match(gun_provisions$state,state.name)]
```

### Clean all

```{r clean-all}
all <- read.csv("data/allshootingsdata.csv")

# Recode subject race
all$SubjectRace[is.na(all$SubjectRace)] <- "U"

# Recode officer races
all$OfficerRace <- gsub("H/L", "L", all$OfficerRace)
all$OfficerRace <- gsub("H", "L", all$OfficerRace)
all$OfficerRace <- gsub("Unknown|m/m", "U", all$OfficerRace)
all$OfficerRace <- gsub("WHITE|WLITE", "W", all$OfficerRace)
all$OfficerRace <- gsub("BLACK", "B", all$OfficerRace)
all$OfficerRace <- gsub("ASIAN", "A", all$OfficerRace)
all$OfficerRace <- gsub("Other|AI/AN|NA/W|Multi-Racial", "O", all$OfficerRace)
all$OfficerRace <- gsub("A/PI ", "A;", all$OfficerRace)
all$OfficerRace <- gsub("A/PI", "A", all$OfficerRace)
all$OfficerRace <- gsub(",", ";", all$OfficerRace)
all$OfficerRace <- gsub(" ", "", all$OfficerRace)
all$OfficerRace <- gsub("A/W|W/L|W/A", "O", all$OfficerRace)
all$OfficerRace[all$OfficerRace == ""] <- "U"

# Recode officer genders
all$OfficerGender <- gsub("MALE", "M", toupper(all$OfficerGender))
all$OfficerGender <- gsub("FEMALE|FEM", "F", toupper(all$OfficerGender))
all$OfficerGender <- gsub("UNKNOWN|FALSE", "U", toupper(all$OfficerGender))
all$OfficerGender <- gsub(",|:", ";", toupper(all$OfficerGender))
all$OfficerGender <- gsub(" |/", "", toupper(all$OfficerGender))

all <- all %>% 
  select(-c("Date", "NatureOfStop", "Notes", "SubjectAge", "NumberOfShots", "Department", "FullNarrative", "fdate", "month", "day", "tr", "AvgAge", "VA", "F", "nshots", "sit")) %>% 
  mutate(b = as.numeric(b > 0),
         w = as.numeric(w > 0),
         l = as.numeric(l > 0),
         a = as.numeric(a > 0),
         so =  as.numeric(str_count(all$SubjectRace, "O") > 0),
         smale = as.numeric(str_count(all$SubjectGender, "M") > 0),
         sfem = as.numeric(str_count(all$SubjectGender, "F") > 0),
         ob = as.numeric(str_count(all$OfficerRace, "B") > 0),
         ow = as.numeric(str_count(all$OfficerRace, "W") > 0),
         ol = as.numeric(str_count(all$OfficerRace, "L") > 0),
         oa = as.numeric(str_count(all$OfficerRace, "A") > 0),
         oo =  as.numeric(str_count(all$OfficerRace, "O") > 0),
         omale = as.numeric(str_count(all$OfficerGender, "M") > 0),
         ofem = as.numeric(str_count(all$OfficerGender, "F") > 0),
         other = as.numeric(other), 
         replica = as.numeric(replica), 
         knife = as.numeric(knife), 
         gun = as.numeric(weapon == "gun"), 
         unarmed = as.numeric(weapon == "unarmed"),
         unknown_weapon = as.numeric(weapon == "U"),
         fatal = as.numeric(str_count(all$Fatal, "F") > 0)) %>% 
  select(-c(weapon, SubjectGender, OfficerRace, OfficerGender))

all <- rename(all, sb = b, sw = w, sl = l, sa = a)
```

```{r filter-all}
# Filter out unknown values
all <- all[-which(all$smale == 0 & all$sfem == 0),]
all <- all[-which(all$omale == 0 & all$ofem == 0),]
all <- all[-which(all$sb == 0 & all$sw == 0 & all$sl == 0 & all$sa == 0),]
all <- all[-which(all$ob == 0 & all$ow == 0 & all$ol == 0 & all$oa == 0),]
all <- all[-which(str_count(all$Fatal, "F") == 0 & str_count(all$Fatal, "N") == 0),]
all <- all %>% 
  select(-c(Fatal))
```

```{r merge-data}
final_df <- merge(all, census, by.x = "city", by.y = "city_name")
final_df <- merge(final_df, gun_provisions, by = "state")
final_df <- final_df %>% 
  select(-c(department, year))
```

```{r save-final-df}
saveRDS(final_df, "data/final.rds")
```

### OLD CODE 
```{r}
all <- all %>% 
  separate_rows(SubjectRace, SubjectGender, Fatal, sep = ";")

officer_gender <- sapply(str_split(all$OfficerGender, ";"), length)
officer_race <- sapply(str_split(all$OfficerRace, ";"), length)
out <- which((officer_gender == officer_race) == FALSE)
all <- all[-out,]

all <- all %>% 
  separate_rows(OfficerRace, OfficerGender, sep = ";") %>% 
  separate_rows(OfficerRace, OfficerGender, sep = ",") 

officer_gender2 <- sapply(str_split(all$OfficerGender, "/"), length)
officer_race2 <- sapply(str_split(all$OfficerRace, "/"), length)
out2 <- which((officer_gender2 == officer_race2) == FALSE)
all <- all[-out2,]

all$OfficerRace <- trimws(all$OfficerRace)
all$OfficerGender <- trimws(all$OfficerGender)
all$Fatal <- trimws(all$Fatal)

all <- all %>% 
  filter(SubjectRace != "U") %>% 
  filter(OfficerRace != "U") %>% 
  filter(OfficerRace != "Unknown") %>% 
  filter(OfficerRace != "NA") %>% 
  filter(OfficerRace != "") %>% 
  filter(OfficerRace != "I") %>% 
  filter(OfficerGender != "U") %>% 
  filter(OfficerGender != "N") %>% 
  filter(SubjectGender != "U") %>% 
  filter(SubjectGender != "N") %>% 
  filter(Fatal != "U")

all$OfficerRace[all$OfficerRace == "WHITE"] <- "W"
all$OfficerRace[all$OfficerRace == "BLACK"] <- "B"
all$OfficerRace[all$OfficerRace == "ASIAN"] <- "A"

all$OfficerGender[all$OfficerGender == "FEMALE"] <- "F"
all$OfficerGender[all$OfficerGender == "MALE"] <- "M"
all$OfficerGender[all$OfficerGender == "Male"] <- "M"

```


```{r split_data}
single_victims <- all %>% 
  filter(!str_detect(SubjectRace, ";"))

mult_victims <- all %>% 
  filter(str_detect(SubjectRace, ";"))
```

## Exploratory Data Analysis 

```{r}
temp <- single_victims %>% 
  group_by(Fatal, SubjectRace) %>% 
  summarise(count = n())
  
ggplot(single_victims, aes(x = Fatal, y = count)) +
  geom_bar(stat="identity") + 
  labs(x = "Fatal", y = "Count", title = "Counts for Fatal vs. Non-Fatal Police Shootings") 
  group_by(Fatal, race) %>% 
  summarise(count = n())
```

```{r fatal-eda}
temp <- all %>% 
  group_by(Fatal) %>% 
  summarise(count = n())

ggplot(temp, aes(x=Fatal, y=count)) + 
  geom_bar(stat="identity") + 
  labs(x = "Fatal", y = "Count", title = "Counts for Fatal vs. Non-Fatal Police Shootings") 
```

```{r race-eda}
temp <- all %>% 
  group_by(Fatal, SubjectRace) %>% 
  summarise(race_count = n())

ggplot(temp, aes(x=SubjectRace, y=race_count, fill = Fatal)) + 
  geom_bar(position="dodge", stat="identity") + 
  labs(x = "Race", y = "Count", title = "Counts for Victim Race by Fatal vs. Non-Fatal in Police Shootings") 

temp2 <- all %>% 
  group_by(Fatal, OfficerRace) %>% 
  summarise(race_count = n())

ggplot(temp2, aes(x=OfficerRace, y=race_count, fill = Fatal)) + 
  geom_bar(position="dodge", stat="identity") + 
  labs(x = "Race", y = "Count", title = "Counts for Officer Race by Fatal vs. Non-Fatal in Police Shootings") 
```

```{r gender-eda}
temp <- all %>% 
  group_by(Fatal, SubjectGender) %>% 
  summarise(gender_count = n())

ggplot(temp, aes(x=SubjectGender, y=gender_count, fill = Fatal)) + 
  geom_bar(position="dodge", stat="identity") + 
  labs(x = "Gender", y = "Count", title = "Counts for Victim Gender by Fatal vs. Non-Fatal in Police Shootings") 

temp2 <- all %>% 
  group_by(Fatal, OfficerGender) %>% 
  summarise(gender_count = n())

ggplot(temp2, aes(x=OfficerGender, y=gender_count, fill = Fatal)) + 
  geom_bar(position="dodge", stat="identity") + 
  labs(x = "Gender", y = "Count", title = "Counts for Officer Race by Fatal vs. Non-Fatal in Police Shootings") 
```

```{r weapon-eda}
temp <- all %>% 
  group_by(Fatal, weapon) %>% 
  summarise(count = n())

ggplot(temp, aes(x=weapon, y=count, fill = Fatal)) + 
  geom_bar(position="dodge", stat="identity") + 
  labs(x = "Weapon Type", y = "Count", title = "Counts of Each Weapon Type on Victims by Fatal vs. Non-Fatal in Police Shootings") 
```

